# Database Migration Runbook (Alembic)

Scope: Postgres schema migrations via Alembic for local dev and Cloud SQL (GCP).

Goals:
- Safe, reversible, auditable schema changes
- Clear sequencing between DB changes and app deploys
- Fast rollback path with concrete smoke checks

## Principles

- Prefer **expand/contract**:
  - Expand: additive schema changes (new columns/tables/indexes) + backward-compatible app code
  - Deploy compatible app code
  - Contract: remove deprecated columns/indexes only after no longer used
- Avoid irreversible migrations in one step:
  - `DROP COLUMN`, destructive type changes, and backfills without idempotency are high-risk
- Always review autogenerated Alembic output (do not trust `--autogenerate` blindly).

## Pre-Flight Checklist

- Working tree clean (or changes intentional).
- Tests green (at minimum: unit tests + a local `alembic upgrade head`).
- Identify target environment: `local` vs `jualuma-dev` (Cloud SQL).
- If the change is risky:
  - Verify Cloud SQL backups/PITR are enabled before applying in GCP.

## Create A Migration

1. Generate the revision:

```bash
alembic revision --autogenerate -m "short description"
```

2. Review the generated file under `alembic/versions/`:
- Confirm constraints/indexes are correct.
- Add `op.execute(...)` for data backfills when needed.
- Make backfills idempotent when possible.

3. If you need a clean local chain test, use:
- `backend/scripts/reset_db_for_migrations.py`

## Local Apply + Verify

1. Ensure DB is reachable (docker compose/local Postgres).
2. Apply:

```bash
alembic upgrade head
alembic current
```

3. Sanity-check the affected tables/indexes:
- Run minimal queries that touch the new columns/tables.
- Start the backend and hit a representative endpoint if applicable.

## GCP (Cloud SQL) Apply + Verify

### Connect

Use one of:
- Cloud SQL Auth Proxy
- Cloud SQL Connector (app path)

For migrations, the proxy is simplest: open a secure local tunnel to Cloud SQL and run Alembic against it using `DATABASE_URL`.

### Apply

```bash
alembic upgrade head
alembic current
```

### Smoke Checks (Minimal)

- Backend health:
  - `GET /health` (or your canonical health endpoint)
- One read-path query that touches migrated schema
- One write-path query (if applicable)
- Watch Cloud Run logs for errors after deploy

## Deployment Sequencing (Recommended)

1. **Expand** migration (additive, backward-compatible)
2. Deploy app revision that can operate on both old/new schema
3. Validate smoke checks
4. Optional: backfill job (if needed)
5. **Contract** migration (remove deprecated schema only after confirmed unused)

## Rollback Options

### App Rollback (Fast)

If the migration is additive, rollback the app first:
- Route traffic to previous Cloud Run revision (no redeploy needed)

### DB Rollback (Only If Safe)

If you must revert schema, prefer reverting only additive steps.

```bash
alembic downgrade -1
alembic current
```

Warnings:
- If the migration dropped/renamed columns or changed types, downgrades can be lossy or fail.
- If data backfills ran, downgrades may not restore prior state.

## Post-Change Checklist

- Migration revision recorded (paste revision id into the PR/issue).
- Observability:
  - Check error rate and latency after deploy
  - Confirm no migration-related exceptions in logs
- Update docs if the migration changes operational behavior.
