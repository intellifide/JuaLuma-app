name: GCP Deploy Guard

on:
  push:
    branches: [Dev]
    paths:
      - ".github/workflows/deploy.yml"
  pull_request:
    paths:
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for env_vars clobber
        run: |
          python3 - ".github/workflows/deploy.yml" <<'PYEOF'
          import sys, re

          deploy_yml_path = sys.argv[1]

          # Services whose env vars are managed entirely on GCP.
          # deploy.yml must NOT have an env_vars block for these.
          GCP_MANAGED_SERVICES = ["jualuma-backend"]

          with open(deploy_yml_path, "r") as f:
              lines = f.readlines()

          violations = []

          for service in GCP_MANAGED_SERVICES:
              in_service = False
              for line in lines:
                  stripped = line.strip()
                  if f'"{service}"' in line and "service:" in line:
                      in_service = True
                      continue
                  if in_service:
                      if re.match(r"^\s+env_vars:\s*\|", line):
                          violations.append(service)
                          break
                      if re.match(r"^\s+-\s+name:", line) or re.match(r"^\s+#", line):
                          break

          if not violations:
              print("✓ deploy.yml is clean — no env_vars blocks for GCP-managed services")
              sys.exit(0)

          print("::error::deploy.yml has env_vars blocks for GCP-managed services: " + ", ".join(violations))
          print("Env vars for these services are managed directly on GCP (Secret Manager).")
          print("Adding env_vars in deploy.yml will overwrite secretKeyRef bindings and drop unlisted vars.")
          print("Remove the env_vars block(s) to fix.")
          sys.exit(1)
          PYEOF
