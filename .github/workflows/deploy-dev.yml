name: CD - Deploy to Dev (jualuma-dev)

on:
  push:
    branches: [Dev]

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: us-central1

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for env_vars clobber
        run: python3 scripts/guard_env_vars.py ".github/workflows/deploy-dev.yml" --output github

  deploy:
    needs: [guard]
    runs-on: ubuntu-latest
    environment: development
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Authorize Docker"
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Load browser API key from Secret Manager
        run: |
          echo "VITE_GCP_API_KEY=$(gcloud secrets versions access latest --secret=VITE_GCP_API_KEY --project=${{ env.PROJECT_ID }})" >> "$GITHUB_ENV"

      # 1. Backend
      - name: Build and Push Backend
        run: |
          docker build -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest -f backend/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest
      # NOTE: Runtime env vars/secrets are controlled via the repository + CI promotion flow.
      # Secrets (via secretKeyRef): DATABASE_URL, STRIPE_SECRET_KEY,
      #   PLAID_CLIENT_ID, PLAID_SECRET, BITQUERY_API_KEY, BLOCKFROST_API_KEY,
      #   LOCAL_ENCRYPTION_KEY, JOB_RUNNER_SECRET,
      #   GMAIL_SA_KEY (-> GOOGLE_APPLICATION_CREDENTIALS)
      # Plain env vars (managed through deployment-controlled service config): APP_ENV, PLAID_ENV,
      #   GCP_PROJECT_ID, STRIPE_PUBLISHABLE_KEY, FRONTEND_URL,
      #   BACKEND_CORS_ORIGINS, GMAIL_IMPERSONATE_USER
      # Do NOT redeclare here without controlled config updates -- doing so overwrites secretKeyRef bindings
      # and drops any vars not listed. See scripts/guard_env_vars.py.
      - name: Deploy Backend
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "jualuma-backend"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest"
          region: ${{ env.REGION }}

      # 2. Frontend App (VITE_GCP_API_KEY required for Identity Platform sign-up/sign-in)
      - name: Build and Push Frontend App
        run: |
          docker build \
            --build-arg VITE_GCP_API_KEY="${{ env.VITE_GCP_API_KEY }}" \
            --build-arg VITE_API_BASE_URL="${{ vars.VITE_API_BASE_URL }}" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest \
            -f frontend-app/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest
      - name: Deploy Frontend App
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "frontend-app"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest"
          region: ${{ env.REGION }}

      # 3. Marketing
      - name: Build and Push Marketing
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_APP_URL="${{ vars.NEXT_PUBLIC_APP_URL }}" \
            --build-arg NEXT_PUBLIC_API_URL="${{ vars.NEXT_PUBLIC_API_URL }}" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest \
            -f frontend-marketing/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest
      - name: Deploy Marketing
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "marketing-site"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest"
          region: ${{ env.REGION }}

      # 4. Support
      - name: Build and Push Support
        run: |
          docker build \
            --build-arg VITE_GCP_API_KEY="${{ env.VITE_GCP_API_KEY }}" \
            --build-arg VITE_API_BASE_URL="${{ vars.VITE_API_BASE_URL }}" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest \
            -f support-portal/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest
      - name: Deploy Support
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "support-portal"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest"
          region: ${{ env.REGION }}
