name: CD - Deploy to Cloud Run

on:
  push:
    branches: [Dev]

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: us-central1

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for env_vars clobber
        run: python3 scripts/guard_env_vars.py ".github/workflows/deploy.yml" --output github

  deploy:
    needs: [guard]
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Authorize Docker"
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      # 1. Backend
      - name: Build and Push Backend
        run: |
          docker build -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest -f backend/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest
      # NOTE: Secrets (DATABASE_URL, STRIPE_*, PLAID_*, SMTP_PASSWORD,
      # BITQUERY_API_KEY, BLOCKFROST_API_KEY, LOCAL_ENCRYPTION_KEY,
      # JOB_RUNNER_SECRET) are bound via Secret Manager directly on
      # Cloud Run. Do NOT redeclare them here as env_vars â€” doing so
      # overwrites the secretKeyRef bindings with plain text and drops
      # any vars not listed.
      - name: Deploy Backend
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "jualuma-backend"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest"
          region: ${{ env.REGION }}

      # 2. Frontend App (VITE_GCP_API_KEY required for Identity Platform sign-up/sign-in)
      - name: Build and Push Frontend App
        run: |
          docker build \
            --build-arg VITE_GCP_API_KEY="${{ vars.VITE_GCP_API_KEY }}" \
            --build-arg VITE_API_BASE_URL="${{ vars.VITE_API_BASE_URL }}" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest \
            -f frontend-app/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest
      - name: Deploy Frontend App
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "jualuma-user-app"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest"
          region: ${{ env.REGION }}

      # 3. Marketing
      - name: Build and Push Marketing
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_APP_URL="https://jualuma-user-app-298159098975.us-central1.run.app" \
            --build-arg NEXT_PUBLIC_API_URL="https://jualuma-backend-298159098975.us-central1.run.app" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest \
            -f frontend-marketing/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest
      - name: Deploy Marketing
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "jualuma-marketing"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest"
          region: ${{ env.REGION }}

      # 4. Support
      - name: Build and Push Support
        run: |
          docker build \
            --build-arg VITE_GCP_API_KEY="${{ vars.VITE_GCP_API_KEY }}" \
            --build-arg VITE_API_BASE_URL="${{ vars.VITE_API_BASE_URL }}" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest \
            -f support-portal/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest
      - name: Deploy Support
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "jualuma-support"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest"
          region: ${{ env.REGION }}
