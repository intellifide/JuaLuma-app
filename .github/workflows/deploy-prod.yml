name: CD - Deploy to Prod (jualuma-prod)

on:
  push:
    branches: [main]

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: us-central1
  BINAUTHZ_ATTESTOR: projects/jualuma-prod/attestors/prod-image-attestor
  BINAUTHZ_KEY_LOCATION: global
  BINAUTHZ_KEYRING: binauthz
  BINAUTHZ_KEY: prod-attestor-key
  BINAUTHZ_KEY_VERSION: "1"

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for env_vars clobber
        run: python3 scripts/guard_env_vars.py ".github/workflows/deploy-prod.yml" --output github

  deploy:
    needs: [guard]
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Authorize Docker"
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Load browser API key from Secret Manager
        run: |
          echo "VITE_GCP_API_KEY=$(gcloud secrets versions access latest --secret=VITE_GCP_API_KEY --project=${{ env.PROJECT_ID }})" >> "$GITHUB_ENV"

      # 1. Backend
      - name: Build and Push Backend
        run: |
          docker build -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest -f backend/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest
          BACKEND_DIGEST=$(gcloud artifacts docker images describe us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest --format='value(image_summary.digest)')
          BACKEND_ARTIFACT=us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend@${BACKEND_DIGEST}
          gcloud beta container binauthz attestations sign-and-create \
            --project=${{ env.PROJECT_ID }} \
            --artifact-url="${BACKEND_ARTIFACT}" \
            --attestor="${{ env.BINAUTHZ_ATTESTOR }}" \
            --keyversion-project=${{ env.PROJECT_ID }} \
            --keyversion-location=${{ env.BINAUTHZ_KEY_LOCATION }} \
            --keyversion-keyring=${{ env.BINAUTHZ_KEYRING }} \
            --keyversion-key=${{ env.BINAUTHZ_KEY }} \
            --keyversion=${{ env.BINAUTHZ_KEY_VERSION }}
      # NOTE: All env vars and secrets are managed directly on GCP (GCP-first).
      # Do NOT redeclare here -- doing so overwrites secretKeyRef bindings
      # and drops any vars not listed. See scripts/guard_env_vars.py.
      - name: Deploy Backend
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "jualuma-backend"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/backend:latest"
          region: ${{ env.REGION }}
          flags: "--binary-authorization=default"

      # 2. Frontend App
      - name: Build and Push Frontend App
        run: |
          docker build \
            --build-arg VITE_GCP_API_KEY="${{ env.VITE_GCP_API_KEY }}" \
            --build-arg VITE_API_BASE_URL="${{ vars.VITE_API_BASE_URL }}" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest \
            -f frontend-app/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest
          FRONTEND_DIGEST=$(gcloud artifacts docker images describe us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest --format='value(image_summary.digest)')
          FRONTEND_ARTIFACT=us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app@${FRONTEND_DIGEST}
          gcloud beta container binauthz attestations sign-and-create \
            --project=${{ env.PROJECT_ID }} \
            --artifact-url="${FRONTEND_ARTIFACT}" \
            --attestor="${{ env.BINAUTHZ_ATTESTOR }}" \
            --keyversion-project=${{ env.PROJECT_ID }} \
            --keyversion-location=${{ env.BINAUTHZ_KEY_LOCATION }} \
            --keyversion-keyring=${{ env.BINAUTHZ_KEYRING }} \
            --keyversion-key=${{ env.BINAUTHZ_KEY }} \
            --keyversion=${{ env.BINAUTHZ_KEY_VERSION }}
      - name: Deploy Frontend App
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "frontend-app"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/frontend-app:latest"
          region: ${{ env.REGION }}
          flags: "--binary-authorization=default"

      # 3. Marketing
      - name: Build and Push Marketing
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_APP_URL="${{ vars.NEXT_PUBLIC_APP_URL }}" \
            --build-arg NEXT_PUBLIC_API_URL="${{ vars.NEXT_PUBLIC_API_URL }}" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest \
            -f frontend-marketing/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest
          MARKETING_DIGEST=$(gcloud artifacts docker images describe us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest --format='value(image_summary.digest)')
          MARKETING_ARTIFACT=us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site@${MARKETING_DIGEST}
          gcloud beta container binauthz attestations sign-and-create \
            --project=${{ env.PROJECT_ID }} \
            --artifact-url="${MARKETING_ARTIFACT}" \
            --attestor="${{ env.BINAUTHZ_ATTESTOR }}" \
            --keyversion-project=${{ env.PROJECT_ID }} \
            --keyversion-location=${{ env.BINAUTHZ_KEY_LOCATION }} \
            --keyversion-keyring=${{ env.BINAUTHZ_KEYRING }} \
            --keyversion-key=${{ env.BINAUTHZ_KEY }} \
            --keyversion=${{ env.BINAUTHZ_KEY_VERSION }}
      - name: Deploy Marketing
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "marketing-site"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/marketing-site:latest"
          region: ${{ env.REGION }}
          flags: "--binary-authorization=default"

      # 4. Support
      - name: Build and Push Support
        run: |
          docker build \
            --build-arg VITE_GCP_API_KEY="${{ env.VITE_GCP_API_KEY }}" \
            --build-arg VITE_API_BASE_URL="${{ vars.VITE_API_BASE_URL }}" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest \
            -f support-portal/Dockerfile .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest
          SUPPORT_DIGEST=$(gcloud artifacts docker images describe us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest --format='value(image_summary.digest)')
          SUPPORT_ARTIFACT=us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal@${SUPPORT_DIGEST}
          gcloud beta container binauthz attestations sign-and-create \
            --project=${{ env.PROJECT_ID }} \
            --artifact-url="${SUPPORT_ARTIFACT}" \
            --attestor="${{ env.BINAUTHZ_ATTESTOR }}" \
            --keyversion-project=${{ env.PROJECT_ID }} \
            --keyversion-location=${{ env.BINAUTHZ_KEY_LOCATION }} \
            --keyversion-keyring=${{ env.BINAUTHZ_KEYRING }} \
            --keyversion-key=${{ env.BINAUTHZ_KEY }} \
            --keyversion=${{ env.BINAUTHZ_KEY_VERSION }}
      - name: Deploy Support
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "support-portal"
          image: "us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/jualuma-repo/support-portal:latest"
          region: ${{ env.REGION }}
          flags: "--binary-authorization=default"
