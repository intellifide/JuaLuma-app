name: deploy-stage

on:
  push:
    branches:
      - stage
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-stage
  cancel-in-progress: false

jobs:
  deploy:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest
    environment: stage
    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID_STAGE || 'jualuma-stage' }}
      REGION: ${{ vars.GCP_REGION_STAGE || 'us-central1' }}
      IMAGE_REPO: ${{ vars.ARTIFACT_REPO_STAGE || 'jualuma-repo' }}
      TAG: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required stage settings
        run: |
          set -euo pipefail
          test -n "${PROJECT_ID}" || (echo "Missing vars.GCP_PROJECT_ID_STAGE" && exit 1)
          test -n "${REGION}" || (echo "Missing vars.GCP_REGION_STAGE" && exit 1)
          test -n "${{ secrets.GCP_WIF_PROVIDER_STAGE || secrets.GCP_WIF_PROVIDER }}" || (echo "Missing secret GCP_WIF_PROVIDER_STAGE" && exit 1)
          test -n "${{ secrets.GCP_WIF_SERVICE_ACCOUNT_STAGE || secrets.GCP_WIF_SERVICE_ACCOUNT }}" || (echo "Missing secret GCP_WIF_SERVICE_ACCOUNT_STAGE" && exit 1)

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER_STAGE || secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT_STAGE || secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Verify required GCP APIs are enabled
        run: |
          set -euo pipefail
          REQUIRED_APIS=(
            "aiplatform.googleapis.com"
            "firestore.googleapis.com"
          )
          for API_NAME in "${REQUIRED_APIS[@]}"; do
            ENABLED_API="$(gcloud services list --enabled --project="${PROJECT_ID}" --filter="name:${API_NAME}" --format='value(config.name)')"
            if [[ "${ENABLED_API}" != "${API_NAME}" ]]; then
              echo "::error::Required API ${API_NAME} is disabled in project ${PROJECT_ID}. Enable it before deploying stage."
              exit 1
            fi
          done

      - name: Configure Artifact Registry auth
        run: gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Load browser API key from Secret Manager
        run: |
          set -euo pipefail
          echo "VITE_GCP_API_KEY=$(gcloud secrets versions access latest --secret=VITE_GCP_API_KEY --project=${PROJECT_ID})" >> "$GITHUB_ENV"

      - name: Validate Plaid production credentials
        run: |
          set -euo pipefail
          export PLAID_CLIENT_ID="$(gcloud secrets versions access latest --secret=PLAID_CLIENT_ID --project=${PROJECT_ID})"
          export PLAID_SECRET="$(gcloud secrets versions access latest --secret=PLAID_SECRET --project=${PROJECT_ID})"
          export PLAID_ENV="production"
          export PLAID_REDIRECT_URI="https://jualuma-user-app-stage-ripznron4a-uc.a.run.app/connect-accounts"
          ./scripts/check_plaid_credentials.sh

      - name: Build and deploy backend
        run: |
          set -euo pipefail
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${IMAGE_REPO}/jualuma-backend-stage:${TAG}"
          docker build -f backend/Dockerfile -t "${IMAGE}" .
          docker push "${IMAGE}"
          gcloud run deploy jualuma-backend-stage \
            --project="${PROJECT_ID}" \
            --region="${REGION}" \
            --image="${IMAGE}" \
            --platform=managed \
            --no-allow-unauthenticated \
            --quiet

      - name: Enforce Plaid production mode on backend runtime
        run: |
          set -euo pipefail
          gcloud run services update jualuma-backend-stage \
            --project="${PROJECT_ID}" \
            --region="${REGION}" \
            --update-env-vars=PLAID_ENV=production,PLAID_REDIRECT_URI=https://jualuma-user-app-stage-ripznron4a-uc.a.run.app/connect-accounts \
            --quiet

      - name: Build and deploy approvals
        run: |
          set -euo pipefail
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${IMAGE_REPO}/jualuma-approvals-stage:${TAG}"
          docker build -f approvals-service/Dockerfile -t "${IMAGE}" .
          docker push "${IMAGE}"
          gcloud run deploy jualuma-approvals-stage \
            --project="${PROJECT_ID}" \
            --region="${REGION}" \
            --image="${IMAGE}" \
            --platform=managed \
            --no-allow-unauthenticated \
            --quiet

      - name: Build and deploy user app
        run: |
          set -euo pipefail
          BACKEND_URL="$(gcloud run services describe jualuma-backend-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"
          if [[ -z "${BACKEND_URL}" ]]; then
            echo "Missing backend stage service URL"
            exit 1
          fi

          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${IMAGE_REPO}/jualuma-user-app-stage:${TAG}"
          docker build \
            -f frontend-app/Dockerfile \
            -t "${IMAGE}" \
            --build-arg VITE_GCP_API_KEY="${{ env.VITE_GCP_API_KEY }}" \
            --build-arg VITE_API_BASE_URL="${BACKEND_URL}" \
            --build-arg VITE_MARKETING_URL="${{ vars.VITE_MARKETING_URL_STAGE }}" \
            --build-arg VITE_MAINTENANCE_MODE="${{ vars.VITE_MAINTENANCE_MODE_STAGE || 'false' }}" \
            .
          docker push "${IMAGE}"
          gcloud run deploy jualuma-user-app-stage \
            --project="${PROJECT_ID}" \
            --region="${REGION}" \
            --image="${IMAGE}" \
            --platform=managed \
            --allow-unauthenticated \
            --quiet

      - name: Build and deploy support portal
        run: |
          set -euo pipefail
          BACKEND_URL="$(gcloud run services describe jualuma-backend-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"
          if [[ -z "${BACKEND_URL}" ]]; then
            echo "Missing backend stage service URL"
            exit 1
          fi

          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${IMAGE_REPO}/jualuma-support-stage:${TAG}"
          docker build \
            -f support-portal/Dockerfile \
            -t "${IMAGE}" \
            --build-arg VITE_GCP_API_KEY="${{ env.VITE_GCP_API_KEY }}" \
            --build-arg VITE_API_BASE_URL="${BACKEND_URL}" \
            .
          docker push "${IMAGE}"
          gcloud run deploy jualuma-support-stage \
            --project="${PROJECT_ID}" \
            --region="${REGION}" \
            --image="${IMAGE}" \
            --platform=managed \
            --allow-unauthenticated \
            --quiet

      - name: Build and deploy marketing
        run: |
          set -euo pipefail
          APP_URL="$(gcloud run services describe jualuma-user-app-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"
          API_URL="$(gcloud run services describe jualuma-backend-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"

          if [[ -z "${APP_URL}" || -z "${API_URL}" ]]; then
            echo "Missing stage URL(s) for marketing build args"
            exit 1
          fi

          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${IMAGE_REPO}/jualuma-marketing-stage:${TAG}"
          docker build \
            -f frontend-marketing/Dockerfile \
            -t "${IMAGE}" \
            --build-arg NEXT_PUBLIC_APP_URL="${APP_URL}" \
            --build-arg NEXT_PUBLIC_API_URL="${API_URL}" \
            .
          docker push "${IMAGE}"
          gcloud run deploy jualuma-marketing-stage \
            --project="${PROJECT_ID}" \
            --region="${REGION}" \
            --image="${IMAGE}" \
            --platform=managed \
            --allow-unauthenticated \
            --quiet

      - name: Align backend runtime URLs (Stage)
        run: |
          set -euo pipefail

          FRONTEND_URL="$(gcloud run services describe jualuma-user-app-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"
          SUPPORT_URL="$(gcloud run services describe jualuma-support-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"
          MARKETING_URL="$(gcloud run services describe jualuma-marketing-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"

          if [[ -z "${FRONTEND_URL}" || -z "${SUPPORT_URL}" || -z "${MARKETING_URL}" ]]; then
            echo "Missing stage service URL(s) needed to align backend runtime URLs"
            exit 1
          fi

          gcloud run services update jualuma-backend-stage \
            --project="${PROJECT_ID}" \
            --region="${REGION}" \
            --update-env-vars="^|^PLAID_ENV=production|PLAID_REDIRECT_URI=${FRONTEND_URL}/connect-accounts|FRONTEND_URL=${FRONTEND_URL}|BACKEND_CORS_ORIGINS=${FRONTEND_URL},${SUPPORT_URL},${MARKETING_URL}|TZ=America/Chicago" \
            --quiet

      - name: Enforce stage runtime timezone (CST/CDT)
        run: |
          set -euo pipefail

          for service in \
            jualuma-backend-stage \
            jualuma-approvals-stage \
            jualuma-user-app-stage \
            jualuma-support-stage \
            jualuma-marketing-stage; do
            gcloud run services update "$service" \
              --project="${PROJECT_ID}" \
              --region="${REGION}" \
              --update-env-vars=TZ=America/Chicago \
              --quiet
          done

      - name: Enforce public runtime access posture (Stage)
        run: |
          set -euo pipefail

          for service in jualuma-backend-stage jualuma-user-app-stage jualuma-support-stage jualuma-marketing-stage; do
            gcloud run services update "$service" \
              --project="${PROJECT_ID}" \
              --region="${REGION}" \
              --no-invoker-iam-check \
              --ingress=all \
              --quiet
          done

          # These stage shell endpoints must not be IAP-intercepted.
          for service in jualuma-user-app-stage jualuma-support-stage; do
            gcloud beta run services update "$service" \
              --project="${PROJECT_ID}" \
              --region="${REGION}" \
              --no-iap \
              --quiet
          done

      - name: Verify public access policy (Stage)
        run: |
          set -euo pipefail

          FRONTEND_URL="$(gcloud run services describe jualuma-user-app-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"
          BACKEND_URL="$(gcloud run services describe jualuma-backend-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"
          SUPPORT_URL="$(gcloud run services describe jualuma-support-stage --project="${PROJECT_ID}" --region="${REGION}" --format='value(status.url)')"

          check_html_or_iap() {
            local url="$1"
            local method="${2:-GET}"
            local data="${3:-}"
            local expect_html="${4:-false}"
            local headers_file body_file status
            headers_file="$(mktemp)"
            body_file="$(mktemp)"

            if [[ "$method" == "POST" ]]; then
              status="$(curl -sS -D "$headers_file" -o "$body_file" \
                -X POST "$url" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer test.invalid.token" \
                --data "$data" \
                -w "%{http_code}")"
            else
              status="$(curl -sS -D "$headers_file" -o "$body_file" "$url" -w "%{http_code}")"
            fi

            if grep -qi '^x-goog-iap-generated-response:' "$headers_file"; then
              echo "::error::IAP interception detected at $url"
              sed -n '1,30p' "$headers_file"
              exit 1
            fi
            if [[ "${expect_html}" != "true" ]] && grep -qi '<html' "$body_file"; then
              echo "::error::HTML gateway response detected at $url (status=$status)"
              sed -n '1,20p' "$headers_file"
              sed -n '1,40p' "$body_file"
              exit 1
            fi
            if [[ "${expect_html}" == "true" ]] && [[ "${status}" -ge 400 ]]; then
              echo "::error::Unexpected status for web shell endpoint at $url (status=$status)"
              sed -n '1,30p' "$headers_file"
              sed -n '1,40p' "$body_file"
              exit 1
            fi
          }

          # Public shell endpoints should not be IAP/gateway HTML.
          check_html_or_iap "${FRONTEND_URL}/" "GET" "" "true"
          check_html_or_iap "${SUPPORT_URL}/" "GET" "" "true"
          check_html_or_iap "${BACKEND_URL}/api/health"

          # Invalid Firebase token should fail in app (JSON), not Cloud Run gateway HTML.
          check_html_or_iap \
            "${BACKEND_URL}/api/auth/signup/pending" \
            "POST" \
            '{"agreements":[],"first_name":"probe","last_name":"probe"}'
