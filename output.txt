============================= test session starts ==============================
platform darwin -- Python 3.11.11, pytest-7.4.4, pluggy-1.5.0
rootdir: /Users/midnight/Projects/jualuma-app/backend
configfile: pytest.ini
plugins: asyncio-0.23.3, anyio-4.12.0, sugar-1.0.0, cov-4.1.0, mock-3.14.0
asyncio: mode=Mode.STRICT
collected 1 item

backend/tests/test_mfa_integration.py F

=================================== FAILURES ===================================
____________________________ test_mfa_complete_flow ____________________________

self = <sqlalchemy.engine.base.Connection object at 0x1387d8a10>
dialect = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x1386af9d0>
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x1385fa550>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x1388dfa50>
parameters = [('test_uid_mfa', 1, 0)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x1386af9d0>
cursor = <sqlite3.Cursor object at 0x1388ab940>
statement = 'SELECT users.uid AS users_uid, users.email AS users_email, users.role AS users_role, users.theme_pref AS users_theme_...ted_at AS users_created_at, users.updated_at AS users_updated_at \nFROM users \nWHERE users.uid = ?\n LIMIT ? OFFSET ?'
parameters = ('test_uid_mfa', 1, 0)
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x1385fa550>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlite3.OperationalError: no such table: users

/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: OperationalError

The above exception was the direct cause of the following exception:

mock_get_email_client = <MagicMock name='get_email_client' id='5241606864'>
mock_verify_token = <MagicMock name='EmailClient' id='5239890000'>
client = <MagicMock name='verify_token' id='5241733712'>
db_session = <sqlalchemy.orm.session.Session object at 0x1386c8e50>

    @patch("backend.services.auth.verify_token")
    @patch("backend.services.email.EmailClient")
    # Note: api/auth calls get_email_client() which returns an instance.
    # We should probably patch get_email_client directly.
    @patch("backend.api.auth.get_email_client")
    def test_mfa_complete_flow(mock_get_email_client, mock_verify_token, client, db_session):
        # Setup mocks
        mock_mailer = MagicMock()
        mock_get_email_client.return_value = mock_mailer
    
        test_uid = "test_uid_mfa"
        test_email = "mfa_test@example.com"
    
        # Mock verify_token response
        mock_verify_token.return_value = {"uid": test_uid, "email": test_email, "sub": test_uid}
    
        # Clean legacy if exists (in memory db persists across module scope fixture)
>       existing = db_session.query(User).filter_by(uid=test_uid).first()

backend/tests/test_mfa_integration.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/orm/query.py:2748: in first
    return self.limit(1)._iter().first()  # type: ignore
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/orm/query.py:2847: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x1386af9d0>
cursor = <sqlite3.Cursor object at 0x1388ab940>
statement = 'SELECT users.uid AS users_uid, users.email AS users_email, users.role AS users_role, users.theme_pref AS users_theme_...ted_at AS users_created_at, users.updated_at AS users_updated_at \nFROM users \nWHERE users.uid = ?\n LIMIT ? OFFSET ?'
parameters = ('test_uid_mfa', 1, 0)
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x1385fa550>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E       [SQL: SELECT users.uid AS users_uid, users.email AS users_email, users.role AS users_role, users.theme_pref AS users_theme_pref, users.currency_pref AS users_currency_pref, users.developer_payout_id AS users_developer_payout_id, users.mfa_secret AS users_mfa_secret, users.mfa_enabled AS users_mfa_enabled, users.mfa_method AS users_mfa_method, users.email_otp AS users_email_otp, users.email_otp_expires_at AS users_email_otp_expires_at, users.created_at AS users_created_at, users.updated_at AS users_updated_at 
E       FROM users 
E       WHERE users.uid = ?
E        LIMIT ? OFFSET ?]
E       [parameters: ('test_uid_mfa', 1, 0)]
E       (Background on this error at: https://sqlalche.me/e/20/e3q8)

/opt/homebrew/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: OperationalError
=============================== warnings summary ===============================
../../../../opt/homebrew/lib/python3.11/site-packages/starlette/formparsers.py:10
  /opt/homebrew/lib/python3.11/site-packages/starlette/formparsers.py:10: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

backend/api/auth.py:34
  /Users/midnight/Projects/jualuma-app/backend/api/auth.py:34: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    email: EmailStr = Field(example="user@example.com")

backend/api/auth.py:35
  /Users/midnight/Projects/jualuma-app/backend/api/auth.py:35: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    password: str = Field(min_length=8, max_length=128, example="Str0ngPass!")

backend/api/auth.py:47
  /Users/midnight/Projects/jualuma-app/backend/api/auth.py:47: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    token: str = Field(min_length=10, example="eyJhbGciOiJSUzI1NiIsImtpZCI6...")

backend/api/auth.py:48
  /Users/midnight/Projects/jualuma-app/backend/api/auth.py:48: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    mfa_code: Optional[str] = Field(default=None, min_length=6, max_length=6, example="123456")

backend/api/auth.py:58
  /Users/midnight/Projects/jualuma-app/backend/api/auth.py:58: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    code: str = Field(min_length=6, max_length=6, example="123456")

backend/api/auth.py:62
  /Users/midnight/Projects/jualuma-app/backend/api/auth.py:62: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    email: EmailStr = Field(example="user@example.com")

backend/api/auth.py:63
  /Users/midnight/Projects/jualuma-app/backend/api/auth.py:63: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    mfa_code: Optional[str] = Field(default=None, min_length=6, max_length=6, example="123456")

backend/api/auth.py:77
  /Users/midnight/Projects/jualuma-app/backend/api/auth.py:77: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    theme_pref: Optional[str] = Field(default=None, max_length=32, example="dark")

backend/api/auth.py:78
  /Users/midnight/Projects/jualuma-app/backend/api/auth.py:78: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    currency_pref: Optional[str] = Field(

../../../../opt/homebrew/lib/python3.11/site-packages/web3/providers/legacy_websocket.py:24
  /opt/homebrew/lib/python3.11/site-packages/web3/providers/legacy_websocket.py:24: DeprecationWarning: websockets.client.connect is deprecated
    from websockets.client import (

../../../../opt/homebrew/lib/python3.11/site-packages/websockets/legacy/__init__.py:6
  /opt/homebrew/lib/python3.11/site-packages/websockets/legacy/__init__.py:6: DeprecationWarning: websockets.legacy is deprecated; see https://websockets.readthedocs.io/en/stable/howto/upgrade.html for upgrade instructions
    warnings.warn(  # deprecated in 14.0 - 2024-11-09

../../../../opt/homebrew/lib/python3.11/site-packages/web3/providers/persistent/websocket.py:18
  /opt/homebrew/lib/python3.11/site-packages/web3/providers/persistent/websocket.py:18: DeprecationWarning: websockets.WebSocketClientProtocol is deprecated
    from websockets import (

../../../../opt/homebrew/lib/python3.11/site-packages/web3/providers/persistent/websocket.py:21
  /opt/homebrew/lib/python3.11/site-packages/web3/providers/persistent/websocket.py:21: DeprecationWarning: websockets.client.connect is deprecated
    from websockets.client import (

backend/api/ai.py:24
  /Users/midnight/Projects/jualuma-app/backend/api/ai.py:24: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    message: str = Field(example="Give me a spending summary for this week.")

backend/api/widgets.py:51
  /Users/midnight/Projects/jualuma-app/backend/api/widgets.py:51: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class WidgetResponse(WidgetBase):

backend/api/developers.py:33
  /Users/midnight/Projects/jualuma-app/backend/api/developers.py:33: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PayoutResponse(BaseModel):

backend/api/support.py:46
  /Users/midnight/Projects/jualuma-app/backend/api/support.py:46: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TicketMessageResponse(BaseModel):

backend/api/support.py:58
  /Users/midnight/Projects/jualuma-app/backend/api/support.py:58: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TicketResponse(BaseModel):

backend/api/support.py:78
  /Users/midnight/Projects/jualuma-app/backend/api/support.py:78: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TicketRatingResponse(BaseModel):

backend/api/notifications.py:16
  /Users/midnight/Projects/jualuma-app/backend/api/notifications.py:16: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class NotificationResponse(BaseModel):

backend/schemas/support_portal.py:13
  /Users/midnight/Projects/jualuma-app/backend/schemas/support_portal.py:13: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TicketResponse(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html

--------- coverage: platform darwin, python 3.11.11-final-0 ----------
Name                                            Stmts   Miss  Cover
-------------------------------------------------------------------
backend/__init__.py                                 0      0   100%
backend/api/__init__.py                             0      0   100%
backend/api/accounts.py                           334    231    31%
backend/api/ai.py                                 109     71    35%
backend/api/analytics.py                          123     87    29%
backend/api/auth.py                               282    208    26%
backend/api/billing.py                             21      4    81%
backend/api/developers.py                          57     20    65%
backend/api/notifications.py                       31      7    77%
backend/api/plaid.py                               73     39    47%
backend/api/support.py                            179    103    42%
backend/api/support_portal.py                      58     36    38%
backend/api/transactions.py                       133     76    43%
backend/api/users.py                               72     51    29%
backend/api/webhooks.py                            11      2    82%
backend/api/widgets.py                            205    130    37%
backend/core/__init__.py                            3      0   100%
backend/core/config.py                             76     17    78%
backend/core/constants.py                          14      0   100%
backend/core/dependencies.py                       30     19    37%
backend/core/events.py                             55     41    25%
backend/core/logging.py                            36     11    69%
backend/create_support_agent.py                    61     61     0%
backend/dev_tools/__init__.py                       0      0   100%
backend/dev_tools/mcp_server.py                   125    125     0%
backend/dev_tools/run_mcp_dev.py                    9      9     0%
backend/main.py                                   120     49    59%
backend/mcp_server.py                              79     61    23%
backend/middleware/__init__.py                      2      0   100%
backend/middleware/auth.py                         86     63    27%
backend/middleware/security.py                     66     43    35%
backend/models/__init__.py                         18      0   100%
backend/models/account.py                          34      4    88%
backend/models/ai_settings.py                      23      2    91%
backend/models/audit.py                            63      4    94%
backend/models/base.py                             19      4    79%
backend/models/category_rule.py                    21      2    90%
backend/models/developer.py                        20      2    90%
backend/models/ledger.py                           45      4    91%
backend/models/manual_asset.py                     27      2    93%
backend/models/notification.py                     40      3    92%
backend/models/payment.py                          22      2    91%
backend/models/payout.py                           24      2    92%
backend/models/subscription.py                     25      2    92%
backend/models/support.py                          71      8    89%
backend/models/transaction.py                      37      3    92%
backend/models/user.py                             50     12    76%
backend/models/widget.py                           31      2    94%
backend/models/widget_rating.py                    24      3    88%
backend/run_mcp_app.py                              9      9     0%
backend/schemas/support_portal.py                  21      0   100%
backend/services/__init__.py                        3      0   100%
backend/services/ai.py                            148    118    20%
backend/services/auth.py                           96     71    26%
backend/services/billing.py                       141    118    16%
backend/services/categorization.py                 30     22    27%
backend/services/connectors.py                    125     83    34%
backend/services/email.py                          66     48    27%
backend/services/notifications.py                  27     17    37%
backend/services/payouts.py                        12     12     0%
backend/services/plaid.py                         153    117    24%
backend/services/prompts.py                         1      0   100%
backend/services/rag.py                            32     25    22%
backend/tests/__init__.py                           0      0   100%
backend/tests/api/__init__.py                       0      0   100%
backend/tests/api/test_accounts_link.py            33     33     0%
backend/tests/api/test_analytics.py                97     97     0%
backend/tests/conftest.py                          86     40    53%
backend/tests/integration_test_marketplace.py     105    105     0%
backend/tests/test_accounts.py                     61     61     0%
backend/tests/test_ai.py                           63     63     0%
backend/tests/test_auth.py                         86     86     0%
backend/tests/test_auth_password_flows.py          62     62     0%
backend/tests/test_connectors.py                   28     28     0%
backend/tests/test_health.py                       14     14     0%
backend/tests/test_mfa_integration.py             106     72    32%
backend/tests/test_payouts_math.py                 25     25     0%
backend/tests/test_security_middleware.py          31     31     0%
backend/tests/test_transactions.py                 57     57     0%
backend/tests/test_webhooks.py                     45     45     0%
backend/tests/test_widgets_rate_limit.py           63     63     0%
backend/utils/__init__.py                           2      0   100%
backend/utils/database.py                          16     10    38%
backend/utils/encryption.py                        42     28    33%
backend/utils/firestore.py                         14      7    50%
-------------------------------------------------------------------
TOTAL                                            4944   3192    35%
Coverage HTML written to dir htmlcov

=========================== short test summary info ============================
FAILED backend/tests/test_mfa_integration.py::test_mfa_complete_flow - sqlalc...
======================== 1 failed, 22 warnings in 1.00s ========================
