graph TD
    %% Styling Definitions
    classDef external fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#01579b
    classDef frontend fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#e65100
    classDef backend fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#1b5e20
    classDef data fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#4a148c
    classDef unseen fill:#fafafa,stroke:#9e9e9e,stroke-width:1px,stroke-dasharray: 5 5,color:#616161

    subgraph External_Ecosystem [External Ecosystem]
        direction TB
        
        subgraph Identity_Payments [Identity & Payments]
            direction TB
            AuthService["Firebase Auth"]:::external
            StripeService["Stripe Payments"]:::external
        end

        subgraph Banking_Fintech [Banking & Fintech]
            direction TB
            PlaidService["Plaid Financial"]:::external
        end

        subgraph AI_Services [AI & ML]
            direction TB
            GenAI["Google Vertex AI / Gemini"]:::external
        end

        subgraph Crypto_Web3 [Crypto & Web3]
            direction TB
            EthNetwork["Ethereum Network (RPC)"]:::external
            CexExchanges["CEXs (Binance, Coinbase, Kraken)"]:::external
        end
    end

    subgraph Frontend_Layer [Frontend Layer]
        direction TB
        UserClient["User Web App (React/Vite)"]:::frontend
        SupportClient["Support Portal (React/Vite)"]:::frontend
    end

    subgraph Backend_Layer [Backend Layer]
        direction TB
        
        subgraph API_Gateway [FastAPI Application]
            direction TB
            AuthRouter["Auth Router"]:::backend
            UsersRouter["Users Router"]:::backend
            AccountsRouter["Accounts Router (Asset Hub)"]:::backend
            TxnRouter["Transactions & Budgets Router"]:::backend
            AnalyticsRouter["Analytics Router"]:::backend
            BillingRouter["Billing Router"]:::backend
            AiRouter["AI Router"]:::backend
            SupportRouter["Support/Tickets Router"]:::backend
            WebhooksRouter["Webhooks Router"]:::backend
        end

        subgraph Core_Services [Internal Services]
            direction TB
            ConnectorService["Connector Service (CEX/Web3)"]:::backend
            PlaidServiceInt["Plaid Service"]:::backend
            AiServiceInt["AI/RAG Service"]:::backend
            AsyncWorker["Async Worker (Pub/Sub Consumer)"]:::backend
        end
    end

    subgraph Data_Layer [Data Layer]
        direction TB
        PostgresDB[("PostgreSQL (pgvector)")]:::data
        FirestoreDB[("Firestore (NoSQL)")]:::data
        PubSub[("Google Pub/Sub")]:::data
        CloudStorage[("Google Cloud Storage")]:::data
    end

    %% --- Frontend Connections ---
    UserClient -->|"Auth SDK"| AuthService
    UserClient -->|"Plaid Link"| PlaidService
    UserClient -->|"Stripe Elements"| StripeService
    UserClient -->|"HTTPS/JSON"| API_Gateway
    SupportClient -->|"HTTPS/JSON"| API_Gateway

    %% --- Backend Router Connections ---
    AuthRouter -->|"Verify Token"| AuthService
    BillingRouter -->|"Manage Subscriptions"| StripeService
    
    %% Accounts & Asset Connectivity
    AccountsRouter -->|"Orchestrate"| ConnectorService
    AccountsRouter -->|"Orchestrate"| PlaidServiceInt
    
    ConnectorService -->|"ccxt (Rest API)"| CexExchanges
    ConnectorService -->|"web3.py (JSON-RPC)"| EthNetwork
    
    PlaidServiceInt -->|"Exchange Token"| PlaidService

    %% AI & Analytics
    AiRouter -->|"Process Request"| AiServiceInt
    AiServiceInt -->|"Generative Queries"| GenAI
    AiServiceInt -->|"Vector Search"| PostgresDB

    %% Data Persistence
    API_Gateway -->|"CRUD Operations"| PostgresDB
    API_Gateway -->|"Metadata/Logs"| FirestoreDB
    API_Gateway -->|"File Uploads"| CloudStorage
    
    %% Event Driven Architecture
    WebhooksRouter -->|"Publish Event"| PubSub
    TransactionRouter -->|"Publish Event"| PubSub
    PubSub -->|"Consume"| AsyncWorker
    AsyncWorker -->|"Process & Write"| PostgresDB
